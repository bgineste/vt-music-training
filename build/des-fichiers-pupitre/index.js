(()=>{"use strict";var e,i={905:()=>{const e=window.wp.blocks,i=window.wp.blockEditor,r=(window.wp.i18n,window.wp.components),t=window.wp.element,n=window.ReactJSXRuntime,c=JSON.parse('{"UU":"vt-music-training/des-fichiers-pupitre"}');(0,e.registerBlockType)(c.UU,{edit:function(e){const c=(0,i.useBlockProps)(),{context:a,attributes:o,setAttributes:s,clientId:l}=e,{"bloc-fichiers-de-travail/cheminFichiers":h}=a,{cheminFichier:p,typeFichier:u,affichageClavier:d,fichierStereo:m}=o;p||s({cheminFichier:h});const v=(0,t.useRef)({}),f=(0,t.useRef)({}),g=o.chaineFichiersPupitre?JSON.parse(o.chaineFichiersPupitre):[],[x,j]=(0,t.useState)(g),b=e=>{const i=JSON.stringify(e);s({chaineFichiersPupitre:i}),j(e)},w=(e,i,r,t)=>{const n=[...x];n[e].fichiers[i][r]=t,b(n)};return(0,n.jsx)("div",{...c,children:e.isSelected?(0,n.jsx)("div",{className:"vt--editor-bloc-pupitres",children:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"vt--editor-params-defaut-pupitres",children:[(0,n.jsx)("h2",{children:'Paramètres par défaut des fichiers "Pupitres"'}),(0,n.jsx)(r.TextControl,{label:"Chemin des fichiers",value:p,onChange:e=>s({cheminFichier:e})}),(0,n.jsx)(r.RadioControl,{label:"Type de fichier",selected:u,options:[{label:"audio",value:"a"},{label:"video",value:"v"}],onChange:e=>s({typeFichier:e})}),(0,n.jsx)(r.ToggleControl,{label:"Afficher le clavier sous le lecteur",checked:d,onChange:e=>s({affichageClavier:e})}),d&&(0,n.jsx)(r.ToggleControl,{label:"Le fichier est stéréo : la voix principale a une piste dédiée",checked:m,onChange:e=>s({fichierStereo:e})})]}),(0,n.jsxs)("div",{className:"vt--editor-panel-wrapper",children:[x.map((e,i)=>(0,n.jsxs)(r.PanelBody,{className:"vt--editor-groupe-pupitres",title:`Groupe ${i+1}`,initialOpen:!0,children:[(0,n.jsx)(r.TextControl,{label:"Titre du groupe (facultatif)",value:e.titre,onChange:e=>((e,i)=>{const r=[...x];r[e].titre=i,b(r)})(i,e)}),e.fichiers.map((e,t)=>{const c=`${i}-${t}`;f.current[c]||(f.current[c]=[e.nomfichier,e.chemin,!1,null]);const[a,o,s,l]=f.current[c];return(0,n.jsxs)("div",{className:"vt--editor-un-pupitre",children:[(0,n.jsx)(r.TextControl,{label:"Label du pupitre",help:"Par ex. : S pour Soprano, A pour Alto...",value:e.label,onChange:e=>w(i,t,"label",e)}),(0,n.jsx)(r.TextControl,{label:"Chemin du fichier",value:e.chemin||o,onChange:e=>w(i,t,"chemin",e)}),(0,n.jsx)(r.TextControl,{label:"Nom du fichier",value:e.nomfichier,readOnly:!0}),(0,n.jsxs)("div",{style:{marginTop:"1em"},children:[(0,n.jsx)("button",{type:"button",onClick:()=>v.current[c]?.click(),className:"components-button is-secondary",children:e.nomfichier?"Choisir un nouveau fichier":"Choisir un fichier"}),(0,n.jsx)("input",{type:"file",accept:"audio/*,video/*",ref:e=>{e&&(v.current[c]=e)},onChange:e=>(async(e,i,r)=>{const t=e.target.files[0],n=`${i}-${r}`;if(!t)return;f.current[n][2]=!0,f.current[n][3]=null;let c=f.current[`${i}-${r}`][1],a=f.current[`${i}-${r}`][0];try{if(a){console.log("suppression "+a);const e=await async function(e,i){if(!vtmtData||!vtmtData.nonce)throw new Error("Nonce manquant ou non injecté.");const r=new FormData;r.append("file",e),r.append("chemin",i);const t=await fetch("/wp-json/vt-music-training/v1/supprimer-fichier",{method:"POST",body:r,credentials:"include",headers:{"X-WP-Nonce":vtmtData.nonce}});if(!t.ok){const e=await t.json();throw new Error(e.message||"Erreur lors de la suppression du fichier précédent")}return await t.json()}(a,c);console.log(e.comment)}const e=await async function(e,i){if(!vtmtData||!vtmtData.nonce)throw new Error("Nonce manquant ou non injecté.");const r=new FormData;r.append("file",e),r.append("chemin",i);const t=await fetch("/wp-json/vt-music-training/v1/upload-fichier",{method:"POST",body:r,credentials:"include",headers:{"X-WP-Nonce":vtmtData.nonce}});if(!t.ok){const e=await t.json();throw new Error(e.message||"Erreur lors de l’upload")}return await t.json()}(t,c);console.log(e),w(i,r,"nomfichier",e.nom),f.current[n][0]=e.nom,console.log("Upload "+e.chemin+" - "+e.nom)}catch(e){console.error(e),f.current[n][3]=e.message}finally{f.current[n][2]=!1}})(e,i,t),style:{display:"none"}})]}),s&&(0,n.jsx)("p",{children:"📤 Téléversement en cours..."}),l&&(0,n.jsxs)("p",{style:{color:"red"},children:["❌ ",l]}),e.nomfichier&&(0,n.jsxs)("div",{style:{marginTop:"1em",maxWidth:"250px"},children:[e.nomfichier.match(/\.(mp3|wav)$/i)&&(0,n.jsx)("audio",{controls:!0,src:`${window.location.origin}${e.chemin}/${e.nomfichier}`,children:"Votre navigateur ne supporte pas l’audio."}),e.nomfichier.match(/\.(mp4|webm)$/i)&&(0,n.jsx)("video",{controls:!0,src:`${window.location.origin}${e.chemin}/${e.nomfichier}`,children:"Votre navigateur ne supporte pas la vidéo."})]}),(0,n.jsx)(r.RadioControl,{label:"Type de fichier",selected:e.typeFichier||u,options:[{label:"audio",value:"a"},{label:"video",value:"v"}],onChange:e=>w(i,t,"typeFichier",e)}),(0,n.jsx)(r.ToggleControl,{label:"Afficher le clavier sous le lecteur",checked:e.affichageClavier||d,onChange:e=>w(i,t,"affichageClavier",e)}),(e.affichageClavier||d)&&(0,n.jsx)(r.ToggleControl,{label:"Le fichier est stéréo : la voix principale a une piste dédiée",checked:e.fichierStereo||m,onChange:e=>w(i,t,"fichierStereo",e)}),(0,n.jsx)(r.Button,{isDestructive:!0,onClick:()=>((e,i)=>{const r=[...x];r[e].fichiers.splice(i,1),b(r)})(i,t),children:"Supprimer ce pupitre"})]},t)}),(0,n.jsx)(r.Button,{onClick:()=>(e=>{const i=[...x];i[e].fichiers.push({label:"",chemin:p,nomfichier:"",typeFichier:u,affichageClavier:d,fichierStereo:m,lyricsPrompter:ancestorPrompter}),b(i)})(i),children:"Ajouter un pupitre"}),(0,n.jsx)(r.Button,{isDestructive:!0,onClick:()=>(e=>{const i=[...x];i.splice(e,1),b(i)})(i),style:{marginTop:"10px"},children:"Supprimer ce groupe"})]},i)),(0,n.jsx)(r.Button,{onClick:()=>{const e=[...x,{titre:"",fichiers:[]}];b(e)},style:{marginTop:"20px"},children:"Ajouter un groupe"})]})]})}):(0,n.jsxs)("div",{children:["Fichiers pupitre",(0,n.jsx)("div",{className:"vt--une-section",children:(0,n.jsx)("div",{className:"vt--fichiers-pupitre",style:{margin:"auto"},children:x.map((e,i)=>(0,n.jsxs)("div",{className:"vt--group-fichiers-pupitre",children:[e.titre&&(0,n.jsx)("div",{className:"vt--group-fichiers-pupitre-titre",children:e.titre}),(0,n.jsx)("div",{className:"vt--pupitre-container",children:e.fichiers.map((e,i)=>(0,n.jsx)("div",{className:"vt--pupitre-button","data-chemin":e.chemin,"data-nomfichier":e.nomfichier,"data-type":e.typeFichier,"data-clavier":e.affichageClavier,"data-stereo":e.fichierStereo,children:(0,n.jsxs)("div",{className:"vt--pupitre-label",children:[" ",e.label," "]})},i))})]},i))})})]})})},save:function({attributes:e}){const r=i.useBlockProps.save(),{chaineFichiersPupitre:t}=e,c=t?JSON.parse(t):[];return(0,n.jsx)("div",{...r,className:"vt--fichiers-pupitre",children:c.map((e,i)=>(0,n.jsxs)("div",{className:"vt--group-fichiers-pupitre",children:[e.titre&&(0,n.jsx)("div",{className:"vt--group-fichiers-pupitre-titre",children:e.titre}),(0,n.jsx)("div",{className:"vt--pupitre-container",children:e.fichiers.map((e,i)=>(0,n.jsx)("div",{className:"vt--pupitre-button","data-chemin":e.chemin,"data-nomfichier":e.nomfichier,"data-type":e.typeFichier,"data-clavier":e.affichageClavier,"data-stereo":e.fichierStereo,children:(0,n.jsxs)("div",{className:"vt--pupitre-label",children:[" ",e.label," "]})},i))})]},i))})}})}},r={};function t(e){var n=r[e];if(void 0!==n)return n.exports;var c=r[e]={exports:{}};return i[e](c,c.exports,t),c.exports}t.m=i,e=[],t.O=(i,r,n,c)=>{if(!r){var a=1/0;for(h=0;h<e.length;h++){for(var[r,n,c]=e[h],o=!0,s=0;s<r.length;s++)(!1&c||a>=c)&&Object.keys(t.O).every(e=>t.O[e](r[s]))?r.splice(s--,1):(o=!1,c<a&&(a=c));if(o){e.splice(h--,1);var l=n();void 0!==l&&(i=l)}}return i}c=c||0;for(var h=e.length;h>0&&e[h-1][2]>c;h--)e[h]=e[h-1];e[h]=[r,n,c]},t.o=(e,i)=>Object.prototype.hasOwnProperty.call(e,i),(()=>{var e={9394:0,4566:0};t.O.j=i=>0===e[i];var i=(i,r)=>{var n,c,[a,o,s]=r,l=0;if(a.some(i=>0!==e[i])){for(n in o)t.o(o,n)&&(t.m[n]=o[n]);if(s)var h=s(t)}for(i&&i(r);l<a.length;l++)c=a[l],t.o(e,c)&&e[c]&&e[c][0](),e[c]=0;return t.O(h)},r=globalThis.webpackChunkvt_music_training=globalThis.webpackChunkvt_music_training||[];r.forEach(i.bind(null,0)),r.push=i.bind(null,r.push.bind(r))})();var n=t.O(void 0,[4566],()=>t(905));n=t.O(n)})();